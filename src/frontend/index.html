<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dog Body Language Interpreter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-hsl: 199, 89%, 48%;
      --secondary-hsl: 258, 90%, 66%;
      --bg: #030712;
      --card-bg: rgba(15, 23, 42, 0.7);
      --panel: rgba(11, 18, 32, 0.5);
      --text: #f8fafc;
      --muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.1);
      --accent: hsl(var(--primary-hsl));
      --accent-2: hsl(var(--secondary-hsl));
      --danger: #ef4444;
    }

    [data-theme="light"] {
      --bg: #f8fafc;
      --card-bg: rgba(255, 255, 255, 0.8);
      --panel: rgba(241, 245, 249, 0.6);
      --text: #0f172a;
      --muted: #64748b;
      --border: rgba(0, 0, 0, 0.1);
      --accent: #0284c7;
      --accent-2: #7c3aed;
    }

    * {
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body {
      margin: 0;
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      background-image: radial-gradient(at 0% 0%, hsla(var(--primary-hsl), 0.15) 0px, transparent 50%), radial-gradient(at 100% 100%, hsla(var(--secondary-hsl), 0.1) 0px, transparent 50%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .logo-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 16px -4px hsla(var(--primary-hsl), 0.5);
    }

    .logo-icon::after {
      content: 'üê∂';
      font-size: 24px;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
      background: rgba(var(--bg), 0.8);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 0;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      text-decoration: none;
      color: inherit;
    }

    .brand h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
    }

    .hero {
      text-align: center;
      padding: 4rem 1.5rem 2rem;
      max-width: 800px;
      margin: 0 auto;
    }

    .hero h2 {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 1rem;
      line-height: 1.1;
    }

    .hero p {
      font-size: 1.25rem;
      color: var(--muted);
      margin-bottom: 2rem;
      font-weight: 300;
    }

    .container {
      flex: 1;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .glass-card {
      background: var(--card-bg);
      backdrop-filter: blur(16px);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .grid-layout {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 2rem;
    }

    @media (max-width: 900px) {
      .grid-layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
    }

    h3 {
      margin-top: 0;
      font-size: 1.1rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 1.25rem;
    }

    .dropzone {
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 2.5rem 1.5rem;
      text-align: center;
      background: rgba(255, 255, 255, 0.02);
      cursor: pointer;
      position: relative;
    }

    .dropzone:hover,
    .dropzone.drag {
      border-color: var(--accent);
      background: rgba(var(--primary-hsl), 0.05);
    }

    .dropzone input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px hsla(var(--primary-hsl), 0.4);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .preview-container {
      aspect-ratio: 4/3;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
    }

    .preview-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .interpretation-bubble {
      background: linear-gradient(135deg, rgba(var(--primary-hsl), 0.1), rgba(var(--secondary-hsl), 0.1));
      border-radius: 20px 20px 20px 4px;
      padding: 1.5rem;
      font-size: 1.1rem;
      margin: 1.5rem 0;
      border: 1px solid var(--border);
    }

    .confidence-meter {
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      margin-top: 12px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(to right, var(--accent), var(--accent-2));
      transition: width 1s ease-out;
    }

    .control-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1.5rem;
      align-items: center;
    }

    .control-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    select,
    input[type="range"] {
      padding: 0.5rem;
      border-radius: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    footer {
      padding: 3rem 1.5rem;
      text-align: center;
      border-top: 1px solid var(--border);
      color: var(--muted);
    }
  </style>
  </style>
</head>

<body>
  <header>
    <div class="header-content">
      <a href="#" class="brand">
        <div class="logo-icon"></div>
        <h1>Dog Translator</h1>
      </a>
      <div class="header-actions">
        <button id="themeToggle" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.85rem;">Light
          Mode</button>
      </div>
    </div>
  </header>

  <div class="hero">
    <h2>Understand What Your Best Friend is Thinking</h2>
    <p>Instant body language interpretation powered by AWS Bedrock AI.</p>
  </div>

  <main class="container">
    <div class="glass-card">
      <div class="grid-layout">
        <div class="main-panel">
          <div class="panel">
            <h3>Image Source</h3>
            <div id="dropzone" class="dropzone">
              <input id="file" type="file" accept="image/png,image/jpeg" />
              <div style="font-size: 1.1rem; font-weight: 500;">Click to upload or drag & drop</div>
              <div style="color: var(--muted); font-size: 0.9rem; margin-top: 8px;">Supports JPG and PNG</div>
            </div>

            <div class="control-group">
              <div class="control-item">
                <span>Tone:</span>
                <select id="toneSelect">
                  <option value="">Default</option>
                  <option value="playful">Playful</option>
                  <option value="calm">Calm</option>
                  <option value="trainer">Trainer</option>
                </select>
              </div>
              <label class="control-item"><input id="saveShare" type="checkbox" /><span>Save & Share</span></label>
              <label class="control-item"><input id="optimize" type="checkbox" checked /><span>Optimize</span></label>
            </div>

            <div style="margin-top: 2rem; display: flex; align-items: center; gap: 12px;">
              <button id="submit" class="btn btn-primary" style="flex: 1; font-size: 1.1rem; padding: 1rem;">Translate
                Body Language</button>
              <div id="loader" class="spinner" style="display:none"></div>
            </div>
            <div id="status" style="margin-top: 1rem; font-size: 0.9rem;"></div>

            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
              <h3>Live Camera</h3>
              <div class="control-item" style="margin-bottom: 1rem;">
                <span>Camera:</span>
                <select id="cameraSelect" style="flex:1"></select>
              </div>
              <div style="display: flex; gap: 10px;">
                <button id="openCam" class="btn btn-outline" style="flex:1">Open Camera</button>
                <button id="capture" class="btn btn-primary" style="display:none; flex:1">Capture</button>
                <button id="closeCam" class="btn btn-outline" style="display:none;">Close</button>
              </div>
              <video id="cam" autoplay playsinline
                style="display:none;width:100%;border-radius:12px; margin-top: 1rem;"></video>
            </div>
          </div>
        </div>

        <div class="result-panel">
          <div class="panel" style="height: 100%; display: flex; flex-direction: column;">
            <h3>Translation</h3>
            <div class="preview-container" id="preview">
              <div style="color: var(--muted);">No image selected</div>
            </div>
            <div id="result" class="interpretation-bubble" style="margin-top: 1.5rem; min-height: 60px;"></div>
            <div id="confidence-container" style="display:none">
              <div style="display:flex; justify-content: space-between; font-size: 0.85rem; color: var(--muted);">
                <span>Confidence</span><span id="confidence-val">0%</span>
              </div>
              <div class="confidence-meter">
                <div id="confidence-fill" class="confidence-fill" style="width: 0%"></div>
              </div>
            </div>
            <div id="shareRow" class="control-group" style="display:none;">
              <span style="font-size: 0.8rem; color: var(--muted);">Link:</span>
              <a id="shareLink" href="#" target="_blank"
                style="font-size: 0.8rem; flex: 1; overflow: hidden; text-overflow: ellipsis;"></a>
              <button id="copyShare" class="btn btn-outline"
                style="padding: 0.3rem 0.6rem; font-size: 0.7rem;">Copy</button>
            </div>
            <div class="control-group" style="margin-top: auto; padding-top: 1.5rem;">
              <div class="control-item" style="width: 100%;"><span>Voice:</span><select id="voiceSelect"
                  style="flex:1"></select></div>
              <div style="display: flex; gap: 8px; width: 100%;">
                <button id="read" class="btn btn-outline" style="flex:1">Speak</button>
                <input id="rateSlider" type="range" min="0.8" max="1.3" step="0.05" value="1" style="width: 60px" />
                <label class="control-item"><input id="autoplay" type="checkbox" /><span>Auto</span></label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <footer>
    <p>&copy; 2025 Dog Translator AI</p>
  </footer>

  <script>
    const API_BASE = '';

    const fileInput = document.getElementById('file');
    const dropzone = document.getElementById('dropzone');
    const submitBtn = document.getElementById('submit');
    const loader = document.getElementById('loader');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const confVal = document.getElementById('confidence-val');
    const confFill = document.getElementById('confidence-fill');
    const confContainer = document.getElementById('confidence-container');
    const shareRow = document.getElementById('shareRow');
    const shareLink = document.getElementById('shareLink');
    const copyShare = document.getElementById('copyShare');
    const preview = document.getElementById('preview');
    const readBtn = document.getElementById('read');
    const autoplay = document.getElementById('autoplay');
    const toneSelect = document.getElementById('toneSelect');
    const saveShare = document.getElementById('saveShare');
    const optimize = document.getElementById('optimize');
    const themeToggle = document.getElementById('themeToggle');
    const voiceSelect = document.getElementById('voiceSelect');
    const rateSlider = document.getElementById('rateSlider');
    const camVideo = document.getElementById('cam');
    const openCamBtn = document.getElementById('openCam');
    const captureBtn = document.getElementById('capture');
    const closeCamBtn = document.getElementById('closeCam');
    const cameraSelect = document.getElementById('cameraSelect');
    const refreshDevicesBtn = document.getElementById('refreshDevices');
    let camStream = null;
    let capturedBlob = null;
    let currentFile = null;
    let voices = [];
    let currentVoiceName = localStorage.getItem('tts.voice') || '';
    let currentRate = parseFloat(localStorage.getItem('tts.rate') || '1');
    rateSlider.value = currentRate;

    function setLoading(loading) {
      submitBtn.disabled = loading;
      loader.style.display = loading ? 'inline-block' : 'none';
      if (loading) {
        resultEl.innerHTML = '<div style="opacity:0.5">Analyzing body language...</div>';
        confContainer.style.display = 'none';
      }
    }

    function showPreview(file) {
      preview.innerHTML = '';
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      preview.appendChild(img);
    }

    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('drag'); });
    dropzone.addEventListener('dragleave', () => { dropzone.classList.remove('drag'); });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault(); dropzone.classList.remove('drag');
      const dt = e.dataTransfer;
      if (!dt || !dt.files[0]) return;
      currentFile = dt.files[0];
      showPreview(currentFile);
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files[0]) {
        currentFile = fileInput.files[0];
        capturedBlob = null;
        showPreview(currentFile);
      }
    });

    themeToggle.addEventListener('click', () => {
      const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      themeToggle.textContent = next === 'light' ? 'Dark Mode' : 'Light Mode';
    });

    function loadVoices() {
      voices = window.speechSynthesis?.getVoices() || [];
      if (voices.length === 0) return;

      // Filter for English, fallback to all if none found
      const englishVoices = voices.filter(v => /^en/i.test(v.lang));
      const list = englishVoices.length ? englishVoices : voices;

      voiceSelect.innerHTML = list.map(v => `<option value="${v.name}">${v.name}</option>`).join('');

      // Restore valid selection
      if (currentVoiceName && list.some(v => v.name === currentVoiceName)) {
        voiceSelect.value = currentVoiceName;
      }
    }

    if ('speechSynthesis' in window) {
      window.speechSynthesis.onvoiceschanged = loadVoices;
      // Chrome needs a little nudge sometimes
      setTimeout(loadVoices, 100);
    }

    voiceSelect.addEventListener('change', () => {
      currentVoiceName = voiceSelect.value;
      localStorage.setItem('tts.voice', currentVoiceName);
    });

    rateSlider.addEventListener('change', () => {
      localStorage.setItem('tts.rate', rateSlider.value);
    });

    async function optimizeImage(fileOrBlob) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const scale = Math.min(1, 1200 / Math.max(img.width, img.height));
          canvas.width = img.width * scale; canvas.height = img.height * scale;
          canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(resolve, 'image/jpeg', 0.85);
        };
        img.src = URL.createObjectURL(fileOrBlob);
      });
    }

    submitBtn.addEventListener('click', async () => {
      let file = capturedBlob ? new File([capturedBlob], 'capture.jpg') : currentFile;
      if (!file) return (statusEl.innerHTML = '<span style="color:var(--danger)">Select image first</span>');

      if (optimize.checked) file = await optimizeImage(file);

      setLoading(true);
      try {
        const form = new FormData();
        form.append('image', file);
        if (toneSelect.value) form.append('tone', toneSelect.value);
        if (saveShare.checked) form.append('save', 'true');

        const res = await fetch(`${API_BASE}/api/interpret`, { method: 'POST', body: form });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Failed');

        const clean = sanitize(data.explanation);
        resultEl.textContent = clean.explanation;
        const conf = Math.round((data.confidence || clean.confidence || 0) * 100);
        confVal.textContent = `${conf}%`;
        confFill.style.width = `${conf}%`;
        confContainer.style.display = 'block';

        if (data.share_id) {
          const url = `${window.location.origin}/share/${data.share_id}`;
          shareLink.href = url; shareLink.textContent = url; shareRow.style.display = 'flex';
        }
        if (autoplay.checked) speak(clean.explanation);
      } catch (err) {
        statusEl.innerHTML = `<span style="color:var(--danger)">${err.message}</span>`;
      } finally { setLoading(false); }
    });

    function sanitize(input) {
      if (!input || typeof input !== 'string') return { explanation: input };
      let s = input.trim().replace(/```json|```/g, '');
      try {
        const obj = JSON.parse(s.match(/\{.*\}/s)[0]);
        return { explanation: obj.explanation, confidence: obj.confidence };
      } catch { return { explanation: s }; }
    }

    copyShare.addEventListener('click', async () => {
      const text = shareLink.textContent;
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        statusEl.innerHTML = '<span class="ok">Copied share link.</span>';
      } catch {
        statusEl.innerHTML = '<span class="error">Unable to copy link.</span>';
      }
    });

    // Text-to-Speech helpers
    function speak(text) {
      if (!('speechSynthesis' in window)) {
        statusEl.innerHTML = '<span class="error">Text-to-speech not supported in this browser.</span>';
        return;
      }
      if (!text || !text.trim()) {
        statusEl.innerHTML = '<span class="error">Nothing to read. Analyze an image first.</span>';
        return;
      }

      // Ensure voices are available
      if (!voices || voices.length === 0) {
        voices = window.speechSynthesis.getVoices();
      }

      // Stop any ongoing speech
      window.speechSynthesis.cancel();

      const utter = new SpeechSynthesisUtterance(text);

      if (voices.length > 0) {
        const selectedVoiceName = voiceSelect.value;
        const selected = voices.find(v => v.name === selectedVoiceName);
        if (selected) {
          utter.voice = selected;
        } else {
          // Fallback to first English voice if selection is invalid
          const en = voices.find(v => /^en/i.test(v.lang));
          if (en) utter.voice = en;
        }
      }

      const rateStr = rateSlider.value;
      utter.rate = parseFloat(rateStr) || 1;

      utter.onerror = (e) => {
        console.error('TTS Error:', e);
        statusEl.innerHTML = '<span class="error">Unable to read aloud.</span>';
      };

      window.speechSynthesis.speak(utter);
    }

    readBtn.addEventListener('click', () => {
      speak(resultEl.textContent);
    });

    // Webcam helpers
    async function openCamera() {
      capturedBlob = null; // reset previous capture
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        statusEl.innerHTML = '<span class="error">Webcam not supported in this browser.</span>';
        return;
      }
      try {
        camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        camVideo.srcObject = camStream;
        camVideo.style.display = 'block';
        captureBtn.style.display = 'inline-block';
        closeCamBtn.style.display = 'inline-block';
        statusEl.textContent = 'Camera active ‚Äî align and capture.';
      } catch (e) {
        statusEl.innerHTML = '<span class="error">Unable to access camera. Check permissions.</span>';
      }
    }

    function closeCamera() {
      if (camStream) {
        camStream.getTracks().forEach(t => t.stop());
        camStream = null;
      }
      camVideo.srcObject = null;
      camVideo.style.display = 'none';
      captureBtn.style.display = 'none';
      closeCamBtn.style.display = 'none';
    }

    async function capturePhoto() {
      if (!camVideo.videoWidth || !camVideo.videoHeight) {
        statusEl.innerHTML = '<span class="error">Camera not ready. Try again.</span>';
        return;
      }
      const canvas = document.createElement('canvas');
      canvas.width = camVideo.videoWidth;
      canvas.height = camVideo.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(camVideo, 0, 0, canvas.width, canvas.height);
      capturedBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.92));
      closeCamera();
      // Show preview of captured photo
      preview.innerHTML = '';
      const img = document.createElement('img');
      img.alt = 'Captured image preview';
      img.src = URL.createObjectURL(capturedBlob);
      preview.appendChild(img);
      statusEl.textContent = 'Photo captured ‚Äî ready to analyze.';
    }

    openCamBtn.addEventListener('click', openCamera);
    captureBtn.addEventListener('click', capturePhoto);
    closeCamBtn.addEventListener('click', () => {
      closeCamera();
      statusEl.textContent = 'Camera closed.';
    });

    // Camera selection and device enumeration
    async function refreshDevices() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
        statusEl.innerHTML = '<span class="error">Device enumeration not supported.</span>';
        return;
      }
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videos = devices.filter(d => d.kind === 'videoinput');
        cameraSelect.innerHTML = '';
        // Add a default option
        const def = document.createElement('option');
        def.value = '';
        def.textContent = 'Default';
        cameraSelect.appendChild(def);
        let idx = 1;
        for (const d of videos) {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `Camera ${idx}`;
          cameraSelect.appendChild(opt);
          idx += 1;
        }
        if (videos.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No cameras found';
          cameraSelect.appendChild(opt);
        }
      } catch (e) {
        statusEl.innerHTML = '<span class="error">Unable to list cameras. Try Open Camera first to grant permission.</span>';
      }
    }

    async function openCamera() {
      capturedBlob = null; // reset previous capture
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        statusEl.innerHTML = '<span class="error">Webcam not supported in this browser.</span>';
        return;
      }
      try {
        // If a camera is already open, close it before switching
        if (camStream) {
          closeCamera();
        }
        const selectedId = cameraSelect?.value || '';
        const constraints = {
          audio: false,
          video: selectedId ? { deviceId: { exact: selectedId } } : { facingMode: 'environment' }
        };
        camStream = await navigator.mediaDevices.getUserMedia(constraints);
        camVideo.srcObject = camStream;
        camVideo.style.display = 'block';
        captureBtn.style.display = 'inline-block';
        closeCamBtn.style.display = 'inline-block';
        statusEl.textContent = 'Camera active ‚Äî align and capture.';
        // Populate device labels after permission
        refreshDevices();
      } catch (e) {
        statusEl.innerHTML = '<span class="error">Unable to access camera. Check permissions or try another device.</span>';
      }
    }

    refreshDevicesBtn.addEventListener('click', refreshDevices);
    cameraSelect.addEventListener('change', () => {
      // If camera is active, switch to the newly selected one
      if (camStream) {
        openCamera();
      }
    });

    // Try to enumerate early; labels may be hidden until permission is granted
    refreshDevices();

    // Frontend sanitizer to avoid showing raw JSON in the interpretation box
    function sanitizeExplanationAndConfidence(input) {
      if (!input || typeof input !== 'string') return { explanation: input };
      let s = input.trim();
      // Strip fenced code blocks if present
      if (s.startsWith('```')) {
        const firstNl = s.indexOf('\n');
        if (firstNl !== -1) s = s.slice(firstNl + 1);
        if (s.endsWith('```')) s = s.slice(0, -3);
        s = s.trim();
      }
      // Try to parse JSON from mixed text
      if (s.includes('{') && s.includes('}')) {
        const start = s.indexOf('{');
        const end = s.lastIndexOf('}');
        if (end > start) {
          const candidate = s.slice(start, end + 1);
          try {
            const obj = JSON.parse(candidate);
            let explanation = String(obj.explanation ?? '').trim();
            let confidence = Number(obj.confidence ?? NaN);
            if (explanation.startsWith('"') && explanation.endsWith('"')) {
              explanation = explanation.slice(1, -1).trim();
            }
            if (!Number.isFinite(confidence)) confidence = undefined;
            return { explanation, confidence };
          } catch { /* fallthrough */ }
        }
      }
      // If it looks like a key:value blob, attempt heuristic extraction
      const lower = s.toLowerCase();
      if (lower.includes('explanation')) {
        const idx = lower.indexOf('explanation');
        const colon = s.indexOf(':', idx);
        if (colon !== -1) {
          let maybe = s.slice(colon + 1).trim();
          maybe = maybe.replace(/^"|"$/g, '').replace(/[}]+$/g, '').trim();
          return { explanation: maybe };
        }
      }
      return { explanation: s };
    }
  </script>
</body>

</html>